<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–¥–∞–∫—Ç–æ—Ä –∫–æ–¥–∞</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <div class="main-container">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞ -->
        <div class="editor-area">
            <div class="editor-header">
                <span>üé® –í–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä —Å –ø–æ–¥—Å–≤–µ—Ç–∫–æ–π —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞</span>
                <span id="currentLanguage">–Ø–∑—ã–∫ –Ω–µ –≤—ã–±—Ä–∞–Ω</span>
            </div>
            <div class="editor-container">
                <div class="virtualized-editor" id="virtualizedEditor"></div>
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
        <div class="sidebar">
            <!-- –í—ã–±–æ—Ä —è–∑—ã–∫–∞ -->
            <div class="sidebar-section">
                <div class="sidebar-header">üåê –Ø–∑—ã–∫ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏—è</div>
                <div class="sidebar-content">
                    <div class="setting-group">
                        <label class="setting-label" for="languageSelect">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫:</label>
                        <select id="languageSelect" class="setting-input">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —è–∑—ã–∫...</option>
                        </select>
                        <div class="language-info" id="languageInfo" style="display: none;">
                            <span class="rule-count" id="ruleCount">0</span> –ø—Ä–∞–≤–∏–ª –∑–∞–≥—Ä—É–∂–µ–Ω–æ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { NFA } from '../automaton/nfa.js';
        import { DFA } from '../automaton/dfa.js';
        import { MealyMachine, runMealy } from '../automaton/mealy.js';
        import { VirtualizedCodeEditor } from './virtualized-editor.js';
        import RULES from './rules.js';

        // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤ –≥–ª–æ–±–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ
        window.NFA = NFA;
        window.DFA = DFA;
        window.MealyMachine = MealyMachine;
        window.runMealy = runMealy;

        // –ö—ç—à —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∞–≤—Ç–æ–º–∞—Ç–æ–≤ –ú–∏–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —è–∑—ã–∫–∞
        const compiledAutomatons = {};
        let currentLanguage = null;
        let virtualizedEditor = null;

        window.addEventListener('load', () => {
            initializeLanguageSelector();
            setupEventListeners();
            
            // –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —è–∑—ã–∫–∞ –∏ —Å–æ–∑–¥–∞–µ–º —Ä–µ–¥–∞–∫—Ç–æ—Ä
            const languages = Object.keys(RULES);
            if (languages.length > 0) {
                changeLanguage(languages[0]);
                initializeVirtualizedEditor();
            }
        });

        function initializeLanguageSelector() {
            const languageSelect = document.getElementById('languageSelect');

            const languages = Object.keys(RULES);

            if (languages.length === 0) {
                return
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ—Å—Ç—É–ø–Ω—ã–µ —è–∑—ã–∫–∏ –≤ —Å–µ–ª–µ–∫—Ç–æ—Ä
            languages.forEach(language => {
                const option = document.createElement('option');
                option.value = language;
                option.textContent = language;
                languageSelect.appendChild(option);
            });

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–µ—Ä–≤—ã–π —è–∑—ã–∫ –∫–∞–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã–π
            languageSelect.value = languages[0];
        }

        function initializeVirtualizedEditor() {
            const container = document.getElementById('virtualizedEditor');
            virtualizedEditor = new VirtualizedCodeEditor(container, null, null, {
                lineHeight: 20,
                fontSize: 14,
                fontFamily: 'Courier New, monospace',
                padding: 12,
                overscan: 10,
                currentLineHighlight: '#2d2d30'
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            virtualizedEditor.hiddenTextarea.value = `// –ü—Ä–∏–º–µ—Ä –∫–æ–¥–∞ JavaScript
function fibonacci(n) {
    if (n <= 1) return n;
    return fibonacci(n - 1) + fibonacci(n - 2);
}

console.log(fibonacci(10));`;
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è –¥–µ—Ä–µ–≤–∞
            virtualizedEditor.lines = virtualizedEditor.hiddenTextarea.value.split('\n');
            virtualizedEditor.totalHeight = virtualizedEditor.lines.length * virtualizedEditor.options.lineHeight + virtualizedEditor.options.padding * 2;
            virtualizedEditor.spacer.style.height = `${virtualizedEditor.totalHeight}px`;
            virtualizedEditor.updateTextareaHeight();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç –∏ –ø—Ä–∞–≤–∏–ª–∞, –µ—Å–ª–∏ –æ–Ω–∏ —É–∂–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω—ã
            if (compiledAutomatons[currentLanguage] && RULES[currentLanguage]) {
                virtualizedEditor.setAutomaton(compiledAutomatons[currentLanguage], RULES[currentLanguage]);
            }

            virtualizedEditor.focus()
        }

        function setupEventListeners() {
            const languageSelect = document.getElementById('languageSelect');

            languageSelect.addEventListener('change', (e) => {
                const selectedLanguage = e.target.value;
                if (selectedLanguage) {
                    changeLanguage(selectedLanguage);
                }
            });
        }

        function changeLanguage(language) {
            currentLanguage = language;

            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            document.getElementById('currentLanguage').textContent = language;
            document.getElementById('ruleCount').textContent = RULES[language].length;
            document.getElementById('languageInfo').style.display = 'block';

            // –ö–æ–º–ø–∏–ª–∏—Ä—É–µ–º –∞–≤—Ç–æ–º–∞—Ç –¥–ª—è —è–∑—ã–∫–∞, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω
            if (!compiledAutomatons[language]) {
                try {
                    compiledAutomatons[language] = compileLanguageAutomaton(language);
                    console.log(`–ê–≤—Ç–æ–º–∞—Ç –¥–ª—è ${language} —É—Å–ø–µ—à–Ω–æ —Å–∫–æ–º–ø–∏–ª–∏—Ä–æ–≤–∞–Ω`);
                } catch (error) {
                    console.error(`–û—à–∏–±–∫–∞ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∞ –¥–ª—è ${language}:`, error);
                    return;
                }
            }

            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç –≤ –≤–∏—Ä—Ç—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –µ—Å–ª–∏ –æ–Ω —Å–æ–∑–¥–∞–Ω
            if (virtualizedEditor) {
                virtualizedEditor.setAutomaton(compiledAutomatons[language], RULES[language]);
            }
        }

        function compileLanguageAutomaton(language) {
            const rules = RULES[language];
            if (!rules || rules.length === 0) {
                throw new Error(`–ü—Ä–∞–≤–∏–ª–∞ –¥–ª—è —è–∑—ã–∫–∞ ${language} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã`);
            }

            const nfas = rules.map(rule => {
                const regexString = rule.Regex.source;
                console.log(language, rule.Name, regexString);
                return NFA.fromRegex(regexString, rule.Name);
            });

            const unionNFA = NFA.union(nfas);
            const dfa = DFA.fromNFA(unionNFA);
            return MealyMachine.fromDFA(dfa);
        }
    </script>
</body>

</html>